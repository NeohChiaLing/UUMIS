<div class="min-h-screen bg-[#f0fdf4] font-display text-slate-800 flex flex-col relative">

  <div *ngIf="viewState === 'years'" class="flex-1 flex flex-col h-full animate-fade-in">
    <header class="bg-white border-b border-emerald-100 px-8 py-8 flex items-center gap-6 sticky top-0 z-40 shadow-sm">
      <button (click)="goBack()" class="size-11 flex items-center justify-center rounded-full bg-white border border-emerald-100 text-slate-400 hover:text-emerald-500 shadow-sm transition-all">
        <span class="material-symbols-outlined font-bold">arrow_back</span>
      </button>
      <div>
        <h1 class="text-3xl font-black text-emerald-900 uppercase">Select <span class="text-emerald-500">Year Group</span></h1>
        <p class="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mt-1">Manage assignments by year</p>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto px-8 py-10">
      <div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        <div *ngFor="let year of years" (click)="selectYear(year)" class="bg-white p-8 rounded-[2rem] border border-emerald-50 shadow-sm hover:shadow-xl hover:scale-[1.02] hover:border-emerald-300 transition-all cursor-pointer flex flex-col items-center justify-center gap-3 group">
          <div class="size-16 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center group-hover:bg-emerald-500 group-hover:text-white transition-colors">
            <span class="material-symbols-outlined text-3xl">groups</span>
          </div>
          <h3 class="text-lg font-black text-slate-800 uppercase">{{ year }}</h3>
        </div>
      </div>
    </div>
  </div>


  <div *ngIf="viewState === 'subjects'" class="flex-1 flex flex-col h-full animate-fade-in">
    <header class="bg-white border-b border-emerald-100 px-8 py-8 flex items-center gap-6 sticky top-0 z-40 shadow-sm">
      <button (click)="goBack()" class="size-11 flex items-center justify-center rounded-full bg-white border border-emerald-100 text-slate-400 hover:text-emerald-500 shadow-sm transition-all">
        <span class="material-symbols-outlined font-bold">arrow_back</span>
      </button>
      <div>
        <h1 class="text-3xl font-black text-emerald-900 uppercase">{{ selectedYear }} <span class="text-emerald-500">Subjects</span></h1>
        <p class="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mt-1">Select a subject to view tasks</p>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto px-8 py-10">
      <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <div *ngFor="let sub of subjects" (click)="selectSubject(sub)" class="bg-white p-8 rounded-[2.5rem] border border-emerald-50 shadow-sm hover:shadow-xl hover:scale-[1.02] transition-all cursor-pointer group flex flex-col items-center text-center gap-4">
          <div class="p-5 rounded-2xl mb-2 transition-colors" [ngClass]="sub.color">
            <span class="material-symbols-outlined text-4xl">{{ sub.icon }}</span>
          </div>
          <div>
            <h3 class="text-xl font-black text-slate-800 uppercase">{{ sub.code }}</h3>
            <p class="text-xs font-bold text-slate-400 mt-1 uppercase tracking-wide">{{ sub.name }}</p>
          </div>
          <div class="mt-4 px-6 py-2 bg-slate-50 rounded-full text-[10px] font-black text-slate-500 uppercase tracking-widest border border-slate-100 group-hover:bg-emerald-500 group-hover:text-white transition-colors">
            View Tasks
          </div>
        </div>
      </div>
    </div>
  </div>


  <div *ngIf="viewState === 'tasks'" class="flex-1 flex flex-col h-full animate-fade-in">
    <header class="bg-white border-b border-emerald-100 px-8 py-8 flex flex-col md:flex-row items-center justify-between gap-6 sticky top-0 z-40 shadow-sm">
      <div class="flex items-center gap-5">
        <button (click)="goBack()" class="size-11 flex items-center justify-center rounded-full bg-white border border-emerald-100 text-slate-400 hover:text-emerald-500 shadow-sm transition-all">
          <span class="material-symbols-outlined font-bold">arrow_back</span>
        </button>
        <div>
          <h1 class="text-3xl font-black text-emerald-900 uppercase">{{ selectedSubject?.code }}</h1>
          <p class="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mt-1">{{ selectedSubject?.name }} Assignments</p>
        </div>
      </div>
      <button (click)="toggleAdding()" class="px-8 py-3 bg-[#f472b6] text-white rounded-xl font-black uppercase text-[10px] shadow-lg shadow-pink-100 hover:bg-[#db2777] transition-all flex items-center gap-2">
        <span class="text-lg leading-none">+</span> Create Assignment
      </button>
    </header>

    <div class="flex-1 overflow-y-auto px-8 py-10">

      <div *ngIf="currentTasks.length === 0" class="h-64 flex flex-col items-center justify-center text-slate-400">
        <span class="material-symbols-outlined text-6xl opacity-30 mb-4">post_add</span>
        <p class="text-sm font-bold uppercase tracking-widest">No assignments yet for {{ selectedSubject?.name }}.</p>
        <p class="text-xs mt-2">Click "Create Assignment" to add one.</p>
      </div>

      <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <div *ngFor="let task of currentTasks" (click)="onCardClick(task)" class="bg-white p-8 rounded-[3rem] border border-emerald-100/50 shadow-sm space-y-6 hover:shadow-xl hover:scale-[1.02] transition-all group cursor-pointer relative overflow-hidden">

          <div class="flex justify-between items-start">
            <span [ngClass]="task.type === 'Assignment' ? 'bg-blue-50 text-blue-600' : 'bg-pink-50 text-pink-600'" class="px-4 py-1 rounded-full text-[9px] font-black uppercase tracking-tighter border border-white/50 shadow-sm">{{task.type}}</span>

            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-all">
              <button (click)="editTask($event, task)" class="p-2 text-emerald-500 hover:bg-emerald-50 rounded-xl" title="Edit"><span class="material-symbols-outlined text-[20px]">edit_note</span></button>
              <button (click)="deleteTask($event, task.id)" class="p-2 text-rose-300 hover:text-rose-500 transition-colors" title="Delete"><span class="material-symbols-outlined text-[20px]">delete</span></button>
            </div>
          </div>

          <div class="space-y-1">
            <p class="text-[10px] font-black text-emerald-500 uppercase tracking-widest">{{task.subject}}</p>
            <h4 class="text-xl font-black text-slate-800 uppercase leading-tight">{{task.topic}}</h4>
            <p *ngIf="task.type === 'Quiz'" class="text-[9px] font-bold text-slate-400 uppercase mt-2">Duration: {{task.durationText}}</p>
          </div>

          <div class="pt-4 border-t border-slate-50 flex justify-between items-center text-slate-400">
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-sm">attach_file</span>
              <span class="text-[9px] font-bold uppercase truncate w-32">{{task.fileName || 'Online Quiz'}}</span>
            </div>
            <span class="text-[9px] font-black uppercase px-2 py-0.5 rounded bg-emerald-50 text-emerald-600">Active</span>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div *ngIf="isAddingMode" class="fixed inset-0 z-[60] flex items-center justify-center bg-emerald-900/20 backdrop-blur-sm p-4">
    <div class="bg-white w-full max-w-2xl rounded-[3rem] border border-emerald-100 shadow-2xl animate-fade-in-up flex flex-col max-h-[90vh] relative overflow-hidden">
      <div class="flex justify-between items-center border-b border-emerald-50 p-8 shrink-0 bg-white z-10">
        <h3 class="text-2xl font-black text-emerald-900 uppercase">{{isEditing ? 'Edit' : 'Create'}} <span class="text-emerald-500">{{newTask.type}}</span></h3>
        <button (click)="toggleAdding()" class="text-slate-300 hover:text-rose-500 p-2"><span class="material-symbols-outlined text-2xl">close</span></button>
      </div>
      <div class="overflow-y-auto p-8 space-y-6 custom-scrollbar flex-1">
        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Type</label><select [(ngModel)]="newTask.type" class="w-full bg-slate-50 border-none rounded-xl p-4 text-sm font-bold shadow-inner"><option value="Assignment">Assignment</option><option value="Quiz">Quiz</option></select></div>
          <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Subject</label><input [(ngModel)]="newTask.subject" readonly class="w-full bg-slate-50 border-none rounded-xl p-4 text-sm font-bold shadow-inner text-slate-500 cursor-not-allowed"></div>
        </div>
        <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Topic / Description</label><textarea [(ngModel)]="newTask.topic" class="w-full bg-slate-50 border-none rounded-xl p-4 text-sm font-bold h-20 outline-none resize-none shadow-inner"></textarea></div>

        <div *ngIf="newTask.type === 'Quiz'" class="space-y-6">
          <div class="flex justify-between items-center"><h4 class="text-[10px] font-black text-emerald-700 uppercase tracking-[0.2em]">Question Builder</h4><button type="button" (click)="addQuestion()" class="px-4 py-2 bg-emerald-500 text-white text-[10px] font-black rounded-lg uppercase hover:bg-emerald-600 transition-all">+ Add Question</button></div>
          <div class="space-y-8">
            <div *ngFor="let q of (newTask.questions || []); let i = index; trackBy: trackByIndex" class="p-6 bg-slate-50 rounded-[2.5rem] border border-slate-100 relative space-y-4">
              <input [(ngModel)]="q.text" placeholder="Type question here..." class="w-full bg-white border-none rounded-xl p-3 text-sm font-bold shadow-sm">
              <div class="grid grid-cols-1 gap-2">
                <div *ngFor="let opt of (q.options || []); let oi = index; trackBy: trackByIndex" class="flex items-center gap-3">
                  <input type="radio" [name]="'ans_'+i" [(ngModel)]="q.correctAnswer" [value]="oi" class="accent-emerald-500">
                  <input [(ngModel)]="q.options[oi]" placeholder="Option text" class="flex-1 bg-white border-none rounded-lg p-2 text-xs">
                  <button type="button" (click)="removeOption(i, oi)" class="text-rose-300 hover:text-rose-500"><span class="material-symbols-outlined text-sm">remove_circle</span></button>
                </div>
                <button type="button" (click)="addOption(i)" class="text-[10px] font-bold text-sky-500 hover:text-sky-600 flex items-center gap-1 mt-1 pl-7">+ Add Option</button>
              </div>
              <div class="flex justify-end"><button type="button" (click)="removeQuestion(i)" class="size-8 bg-rose-50 text-rose-500 rounded-lg flex items-center justify-center hover:bg-rose-500 hover:text-white transition-all"><span class="material-symbols-outlined text-sm font-bold">delete</span></button></div>
            </div>
          </div>
          <div class="bg-emerald-50/40 p-6 rounded-[2.5rem] space-y-4 border border-emerald-100/50">
            <h4 class="text-[9px] font-black text-emerald-800 uppercase tracking-widest">Scheduling & Duration</h4>
            <div class="grid grid-cols-2 gap-4">
              <input type="date" [(ngModel)]="newTask.quizDate" class="bg-white border-none rounded-xl p-3 text-xs font-bold shadow-sm w-full">
              <div class="flex gap-2 items-center"><input type="time" [(ngModel)]="newTask.startTime" (change)="calculateDuration()" class="bg-white border-none rounded-xl p-3 text-xs font-bold shadow-sm w-full"><span class="text-slate-300 font-bold text-[10px]">TO</span><input type="time" [(ngModel)]="newTask.endTime" (change)="calculateDuration()" class="bg-white border-none rounded-xl p-3 text-xs font-bold shadow-sm w-full"></div>
            </div>
            <div class="flex items-center gap-3 py-2"><span class="text-[9px] font-black text-slate-400 uppercase">Calculated Duration:</span><span class="px-4 py-1 bg-white rounded-lg text-[10px] font-black text-emerald-600 shadow-sm">{{newTask.durationText}}</span></div>
            <div class="flex items-center justify-between pt-2"><span class="text-[9px] font-black text-emerald-800 uppercase">Release Marks?</span><div (click)="newTask.releaseMarks = !newTask.releaseMarks" [class]="newTask.releaseMarks ? 'bg-emerald-500' : 'bg-slate-300'" class="w-10 h-5 rounded-full p-0.5 cursor-pointer transition-all"><div [class]="newTask.releaseMarks ? 'translate-x-5' : 'translate-x-0'" class="size-4 bg-white rounded-full transition-all"></div></div></div>
          </div>
        </div>

        <div *ngIf="newTask.type === 'Assignment'" class="space-y-4">
          <div (click)="fileInput.click()" class="w-full border-2 border-dashed border-emerald-200 rounded-[2rem] p-8 flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-emerald-50 transition-all"><span class="material-symbols-outlined text-emerald-400 text-4xl">upload_file</span><span class="text-xs font-bold text-emerald-600 uppercase">{{ newTask.fileName || 'Upload PDF' }}</span><input #fileInput type="file" class="hidden" (change)="onFileSelected($event)" accept="application/pdf"></div>
          <input type="datetime-local" [(ngModel)]="newTask.dueDate" class="w-full bg-slate-50 border-none rounded-xl p-4 text-sm font-bold shadow-inner">
        </div>
      </div>
      <div class="p-8 pt-0 shrink-0 bg-white z-10">
        <button (click)="saveTask()" class="w-full py-5 bg-emerald-500 text-white font-black uppercase tracking-widest rounded-full shadow-lg shadow-emerald-200 hover:scale-105 transition-all">Submit & Schedule</button>
      </div>
    </div>
  </div>

  <div *ngIf="showQuizStartConfirm" class="fixed inset-0 z-[120] flex items-center justify-center bg-emerald-900/40 backdrop-blur-sm p-6 animate-fade-in">
    <div class="bg-white w-full max-w-md p-8 rounded-[2.5rem] border border-emerald-100 shadow-2xl text-center space-y-6">
      <div class="size-16 rounded-full bg-emerald-50 text-emerald-500 flex items-center justify-center mx-auto shadow-inner">
        <span class="material-symbols-outlined text-3xl">play_arrow</span>
      </div>
      <div>
        <h4 class="text-2xl font-black text-emerald-900 uppercase">Preview Quiz</h4>
        <p class="text-xs font-bold text-slate-400 mt-2">Teacher Mode: View Only</p>
      </div>
      <button (click)="showQuizStartConfirm = false" class="w-full py-3 bg-slate-100 text-slate-500 font-black rounded-2xl uppercase text-[10px] hover:bg-slate-200">Close</button>
    </div>
  </div>

  <div *ngIf="showAssignmentDetails" class="fixed inset-0 z-[120] flex items-center justify-center bg-emerald-900/40 backdrop-blur-sm p-6 animate-fade-in">
    <div class="bg-white w-full max-w-lg p-10 rounded-[3rem] border border-emerald-100 shadow-2xl space-y-8 relative">
      <button (click)="showAssignmentDetails = false" class="absolute top-6 right-6 text-slate-300 hover:text-rose-500 transition-colors">
        <span class="material-symbols-outlined text-2xl">close</span>
      </button>
      <div class="text-center">
        <h3 class="text-2xl font-black text-slate-800 uppercase">Assignment Details</h3>
      </div>
      <div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-100 space-y-4">
        <p class="text-lg font-black text-emerald-600 uppercase">{{clickedTask?.subject}}</p>
        <p class="text-sm font-bold text-slate-700 leading-relaxed">{{clickedTask?.topic}}</p>
      </div>
      <button (click)="confirmDownload()" class="w-full py-4 bg-blue-500 text-white font-black uppercase tracking-widest rounded-2xl shadow-xl shadow-blue-100 hover:scale-105 transition-all flex items-center justify-center gap-3">
        <span class="material-symbols-outlined">download</span> Download PDF
      </button>
    </div>
  </div>

</div>
